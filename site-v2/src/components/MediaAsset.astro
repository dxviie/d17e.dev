---
// MediaAsset.astro
import { getImageUrl, getVideoUrl, getVideoPosterUrl, getImageSrcset, getOriginalExtension, getBestImageVariant, getAvailableVideoVariants, MEDIA_CDN_URL } from "../utils/mediaUrls";

interface MediaAssetProps {
  id: string;
  alt?: string;
  type?: string;
  filenameDownload?: string;
  width?: number;          // Display width
  height?: number;         // Display height
  originalWidth?: number;  // Original source image width (from Directus)
  originalHeight?: number; // Original source image height (from Directus)
  isHero?: boolean;
  objectFit?: string;      // CSS property for object-fit
  loading?: "eager" | "lazy"; // Image loading strategy
}

const {
  id,
  alt = "Media asset",
  type = "",
  filenameDownload,
  width = 800,
  height = 450,
  originalWidth,
  originalHeight,
  isHero = false,
  objectFit = "cover", // Default object-fit value
  loading = "lazy" // Default to lazy loading
} = Astro.props;

const isVideo = type?.startsWith("video/");
const showVideo = isVideo && isHero;

// Extract original file extension from filenameDownload or MIME type
const originalExt = getOriginalExtension(filenameDownload, type);

// CDN URLs for images - use original width to determine available variants (original must be > variant)
const cdnImageSrcset = getImageSrcset(id, originalWidth, originalExt);
// For hero images, use the best available large variant
const heroVariant = getBestImageVariant(originalWidth, 1920);
const cdnImageUrlLarge = getImageUrl(id, heroVariant, heroVariant === 'original' ? originalExt : undefined);
// For regular images, use the best variant for typical display
const regularVariant = getBestImageVariant(originalWidth, 800);
const cdnImageUrl = getImageUrl(id, regularVariant, regularVariant === 'original' ? originalExt : undefined);

// CDN URLs for video: only use variants that exist (â‰¤ original height); original always exists as fallback
const availableVideoVariants = getAvailableVideoVariants(originalHeight);
const cdnVideoUrlOriginal = getVideoUrl(id, 'original', originalExt);
const cdnVideoPosterUrl = getVideoPosterUrl(id);

// CDN URL for original asset link (uses actual file extension)
const cdnOriginalUrl = isVideo 
  ? `${MEDIA_CDN_URL}/videos/${id}/original.${originalExt}`
  : `${MEDIA_CDN_URL}/images/${id}/original.${originalExt}`;
---

<figure class="media-asset" data-is-video={isVideo.toString()} data-id={id} data-hero={isHero.toString()}>
  {showVideo ? (
          <div class="video-container">
            <video
                    class={`astro-media ${isHero ? 'hero-media' : ''}`}
                    poster={cdnVideoPosterUrl}
                    width={width}
                    height={height}
                    preload="metadata"
                    autoplay
                    loop
                    muted
                    playsinline
                    data-has-audio="checking"
            >
              <!-- CDN video sources: only variants that exist (â‰¤ original height), then original as fallback -->
              {availableVideoVariants.includes('1080p') && <source src={getVideoUrl(id, '1080p')} type="video/mp4" media="(min-width: 1024px)" />}
              {availableVideoVariants.includes('720p') && <source src={getVideoUrl(id, '720p')} type="video/mp4" media="(min-width: 600px)" />}
              {availableVideoVariants.includes('480p') && <source src={getVideoUrl(id, '480p')} type="video/mp4" />}
              <source src={cdnVideoUrlOriginal} type={type || 'video/mp4'} />
              Your browser does not support the video tag.
            </video>
            <button class="mute-toggle" aria-label="Toggle audio" title="Toggle mute" style="display: none;">
              <span class="icon-muted">ðŸ”‡</span>
              <span class="icon-unmuted">ðŸ”Š</span>
            </button>
          </div>
  ) : (
          <div class="media-wrapper">
            {!isVideo && isHero && (
                      <a href={cdnOriginalUrl} target="_blank" rel="noopener noreferrer" class="asset-link">
                        <img
                                class={`astro-media hero-media`}
                                src={cdnImageUrlLarge}
                                srcset={cdnImageSrcset}
                                sizes="(max-width: 600px) 400px, (max-width: 1024px) 800px, (max-width: 1440px) 1200px, 1920px"
                                width={width}
                                height={height}
                                alt={alt}
                                loading={loading}
                                style={`object-fit: ${objectFit}; object-position: center;`}
                        />
                        <div class="link-indicator" title="View original asset"></div>
                      </a>
            )}
            {!isVideo && !isHero && (
                              <img
                                      class="astro-media"
                                      src={cdnImageUrl}
                                      srcset={cdnImageSrcset}
                                      sizes="(max-width: 600px) 400px, (max-width: 1024px) 800px, 1200px"
                                      width={width}
                                      height={height}
                                      alt={alt}
                                      loading={loading}
                                      style={`object-fit: ${objectFit}; object-position: center; transform: scale(1.1);`}
                              />
            )}
            {isVideo && !isHero && (
                    <img
                            class="astro-media video-poster"
                            src={cdnVideoPosterUrl}
                            width={width}
                            height={height}
                            alt={alt}
                            loading={loading}
                            style={`object-fit: ${objectFit}; object-position: center; transform: scale(1.1);`}
                    />
            )}
            {isVideo && !isHero && (
                    <div class="video-hover-container">
                      <video
                              class="atro-media hover-video"
                              poster={cdnVideoPosterUrl}
                              width={width}
                              height={height}
                              preload="none"
                              loop
                              muted
                              playsinline
                      >
                        {availableVideoVariants.includes('720p') && <source src={getVideoUrl(id, '720p')} type="video/mp4" media="(min-width: 600px)" />}
                        {availableVideoVariants.includes('480p') && <source src={getVideoUrl(id, '480p')} type="video/mp4" />}
                        <source src={cdnVideoUrlOriginal} type={type || 'video/mp4'} />
                      </video>
                      <div class="play-indicator"></div>
                    </div>
            )}
          </div>
  )}
</figure>

<style>
    .media-asset {
        margin: 0;
        width: 100%;
        height: 100%;
        position: relative;
    }

    .media-wrapper {
        position: relative;
        overflow: hidden;
        border-radius: 4px;
        width: 100%;
        height: 100%;
    }

    .astro-media {
        object-fit: cover;
    }

    .astro-media.hero-media {
        object-fit: contain !important;
        object-position: top !important;
        //margin-top: 4rem;
    }

    @media (max-width: 600px), (max-width: 1024px) and (pointer: coarse) {
        .astro-media.hero-media {
            margin-top: 1rem;
        }
    }

    img {
        width: 100%;
        height: 100%;
        display: block;
        border-radius: 4px;
    }

    .video-container {
        position: relative;
        width: 100%;
        border-radius: 4px;
        overflow: hidden;
    }

    .video-hover-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 1;
    }

    .media-wrapper:hover .video-hover-container,
    .media-wrapper:focus .video-hover-container {
        opacity: 1;
    }

    .hover-video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    video {
        width: 100%;
        height: auto;
        display: block;
        max-height: 80vh;
    }

    .play-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 60px;
        height: 60px;
        background-color: rgba(0, 0, 0, 0.5);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0.7;
        transition: opacity 0.3s ease;
        pointer-events: none;
    }

    .play-indicator::after {
        content: '';
        width: 0;
        height: 0;
        border-top: 12px solid transparent;
        border-bottom: 12px solid transparent;
        border-left: 20px solid white;
        margin-left: 4px;
    }

    .media-wrapper:hover .play-indicator {
        opacity: 0;
    }

    .asset-link {
        display: block;
        position: relative;
        width: 100%;
        height: 100%;
    }

    .link-indicator {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 24px;
        height: 24px;
        background-color: rgba(0, 0, 0, 0.5);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease, transform 0.2s ease;
        z-index: 10;
        pointer-events: none;
    }

    .link-indicator::after {
        content: 'â†—';
        color: white;
        font-size: 14px;
        line-height: 1;
    }

    .asset-link:hover .link-indicator,
    .asset-link:focus .link-indicator {
        opacity: 0.8;
        transform: scale(1.1);
    }

    .mute-toggle {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background-color: rgba(0, 0, 0, 0.5);
        border: none;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 10;
    }

    .video-container:hover .mute-toggle {
        opacity: 0.8;
    }

    @media (max-width: 768px) {
        .video-container .mute-toggle {
            opacity: 0.8;
        }
    }

    .mute-toggle:hover {
        opacity: 1;
        background-color: rgba(0, 0, 0, 0.7);
    }

    .icon-unmuted {
        display: none;
    }

    .video-container.unmuted .icon-muted {
        display: none;
    }

    .video-container.unmuted .icon-unmuted {
        display: block;
    }

    figcaption {
        font-size: 0.875rem;
        margin-top: 0.5rem;
        color: #666;
        text-align: center;
    }
</style>

<script>
  document.addEventListener('astro:page-load', () => {
    setupVideoHovers();
    playHeroVideos();
    setupAssetLinks();
  });

  function setupVideoHovers() {
    const mediaAssets = document.querySelectorAll('.media-asset[data-is-video="true"]:not([data-hero="true"])');

    mediaAssets.forEach(asset => {
      // Skip if already initialized
      if (asset.hasAttribute('data-video-initialized')) return;

      const wrapper = asset.querySelector('.media-wrapper');
      const video = asset.querySelector<HTMLVideoElement>('.hover-video');
      const assetLink = asset.querySelector<HTMLAnchorElement>('.asset-link');

      if (!wrapper || !video) return;

      // Mark as initialized to prevent duplicate event handlers
      asset.setAttribute('data-video-initialized', 'true');

      // For desktop: hover events
      let playPromise: Promise<void> | undefined;

      wrapper.addEventListener('mouseenter', () => {
        // Only attempt to play if video is paused
        if (video.paused) {
          playPromise = video.play();
          playPromise?.catch(e => console.log('Autoplay prevented:', e));
        }
      });

      wrapper.addEventListener('mouseleave', () => {
        // Check if there's an ongoing play promise
        if (playPromise !== undefined) {
          playPromise.then(() => {
            // Only pause if video is still playing
            if (!video.paused) {
              video.pause();
              video.currentTime = 0;
            }
          }).catch(() => {
            // Promise rejected, do nothing as play likely failed
          });
        } else {
          // No active promise, safe to pause
          if (!video.paused) {
            video.pause();
            video.currentTime = 0;
          }
        }
      });

      // For mobile: touch events
      let touchTimeout: NodeJS.Timeout;
      let touchPlayPromise: Promise<void> | undefined;

      wrapper.addEventListener('touchstart', () => {
        touchTimeout = setTimeout(() => {
          // Only play if video is paused
          if (video.paused) {
            touchPlayPromise = video.play();
            touchPlayPromise?.catch(e => console.log('Autoplay prevented:', e));
          }
        }, 200); // Small delay to differentiate from click/tap
      }, { passive: true });

      wrapper.addEventListener('touchend', () => {
        clearTimeout(touchTimeout);
        // Don't pause immediately on touchend to allow viewing on mobile
      }, { passive: true });

      wrapper.addEventListener('touchmove', () => {
        clearTimeout(touchTimeout);
      }, { passive: true });
    });
  }

  function playHeroVideos() {
    // Find and play all hero videos (these have autoplay attribute but need to be manually started after page transitions)
    const heroVideos = document.querySelectorAll('.video-container video[autoplay]');
    heroVideos.forEach(video => {
      if (video instanceof HTMLVideoElement && video.paused) {
        // Only attempt to play if the video is currently paused
        video.play().catch(e => console.log('Hero video autoplay prevented:', e));
      }
    });

    // Setup mute toggles after hero videos are initialized
    setTimeout(() => {
      setupMuteToggles();
    }, 100);
  }

  // Also run on initial page load
  document.addEventListener('DOMContentLoaded', () => {
    setupVideoHovers();
    playHeroVideos();
    setupAssetLinks();
  });

  function setupAssetLinks() {
    // Handle clicks on videos to toggle controls rather than follow the link
    document.querySelectorAll('.video-container .asset-link').forEach(link => {
      const video = link.querySelector('video');
      if (!video) return;

      // Prevent video click from triggering the link navigation
      video.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();

        // Toggle video controls
        video.controls = !video.controls;
      });

      // Make sure link indicator click still navigates to the asset
      const indicator = link.querySelector('.link-indicator');
      if (indicator) {
        indicator.addEventListener('click', (e) => {
          e.stopPropagation(); // Don't let it bubble to video click handler
          window.open(link.href, '_blank', 'noopener,noreferrer');
        });
      }
    });

    // Setup mute toggle buttons for videos
    setupMuteToggles();
  }

  function setupMuteToggles() {
    document.querySelectorAll('.video-container').forEach(container => {
      const video = container.querySelector('video');
      const muteButton = container.querySelector('.mute-toggle');

      if (!video || !muteButton) return;

      // Skip if already initialized
      if (muteButton.hasAttribute('data-mute-initialized')) return;
      muteButton.setAttribute('data-mute-initialized', 'true');

      // Show mute button
      muteButton.style.display = 'flex';

      // Setup toggle button click handler
      muteButton.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();

        // Toggle muted state
        video.muted = !video.muted;

        // Update container class for styling
        if (video.muted) {
          container.classList.remove('unmuted');
        } else {
          container.classList.add('unmuted');

          // Attempt to play if it was paused (mobile browsers often require user interaction)
          if (video.paused) {
            video.play().catch(err => console.log('Could not play video after unmuting:', err));
          }
        }
      });

      // Also setup mute toggle when video is loaded
      video.addEventListener('loadedmetadata', () => {
        if (!muteButton.hasAttribute('data-mute-initialized')) {
          muteButton.style.display = 'flex';
          muteButton.setAttribute('data-mute-initialized', 'true');
        }
      });
    });
  }
</script>
