---
import ColorModeToggle from "./ColorModeToggle.astro";

const pathname = Astro.url.pathname;
const isHomePage = pathname === "/" || pathname === "";
const isPostsIndex = pathname.endsWith("posts/") || pathname.endsWith("posts");
const isBlogIndex = pathname.endsWith("blog/") || pathname.endsWith("blog");
const isProjectsIndex =
  pathname.endsWith("projects/") || pathname.endsWith("projects");
const isAboutPage = pathname.endsWith("about/") || pathname.endsWith("about");
---

<nav id="mobile-nav">
  <!-- Logo on the left (hidden on home page) -->
  {
    !isHomePage && (
      <a href="/" class="logo-link" aria-label="Home">
        <svg
          class="logo-image"
          viewBox="0 0 1020 448"
          role="img"
          aria-label="D17E logo"
        >
          <g transform="matrix(1,0,0,1,0,-0.37142)">
            <g transform="matrix(1.2778,0,0,0.628916,-169.768,-154.588)">
              <path
                d="M930.998,957.183L132.86,957.183L132.86,246.391L930.998,246.391L930.998,957.183ZM399.748,807.315L517.675,807.315L517.675,734.622L477.603,734.622L477.603,400.234L441.538,400.234L441.538,417.68C441.538,444.431 436.099,452.573 422.647,452.573L401.18,452.573L401.18,522.358L441.252,522.358L441.252,734.622L399.748,734.622L399.748,807.315ZM586.656,807.315L627.3,807.315L706.3,475.253L706.3,400.234L566.047,400.234L566.047,472.345L665.655,472.345L586.656,801.499L586.656,807.315ZM208.261,807.315L268.083,807.315C326.76,807.315 354.238,728.806 354.238,627.036L354.238,580.513C354.238,478.742 326.76,400.234 268.083,400.234L208.261,400.234L208.261,807.315ZM245.471,734.622L245.471,472.927L268.083,472.927C306.438,472.927 317.028,516.543 317.028,580.513L317.028,627.036C317.028,691.006 306.438,734.622 268.083,734.622L245.471,734.622ZM750.665,807.315L876.606,807.315L876.606,735.785L787.875,735.785L787.875,632.852L867.733,632.852L867.733,561.903L787.875,561.903L787.875,471.764L876.606,471.764L876.606,400.234L750.665,400.234L750.665,807.315Z"
                fill="currentColor"
              />
            </g>
          </g>
        </svg>
      </a>
    )
  }

  <div class="spacer"></div>

  <!-- Color mode toggle -->
  <ColorModeToggle />

  <!-- Burger menu button -->
  <button
    class="burger-button"
    id="burger-button"
    aria-label="Open menu"
    aria-expanded="false"
    aria-controls="mobile-menu"
  >
    <span class="burger-line"></span>
    <span class="burger-line"></span>
    <span class="burger-line"></span>
  </button>
</nav>

<!-- Fullscreen menu overlay -->
<div id="mobile-menu" class="mobile-menu" aria-hidden="true">
  <div class="menu-content">
    <a href="/" class={`menu-item ${isHomePage ? "active" : ""}`}>
      <span class="menu-label">home</span>
    </a>
    <a href="/projects" class={`menu-item ${isProjectsIndex ? "active" : ""}`}>
      <span class="menu-label">projects</span>
    </a>
    <a href="/posts" class={`menu-item ${isPostsIndex ? "active" : ""}`}>
      <span class="menu-label">media</span>
    </a>
    <a href="/blog" class={`menu-item ${isBlogIndex ? "active" : ""}`}>
      <span class="menu-label">blog</span>
    </a>
    <a href="/about" class={`menu-item ${isAboutPage ? "active" : ""}`}>
      <span class="menu-label">about</span>
    </a>
  </div>
</div>

<style>
  nav {
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1000;
    display: none;
    width: calc(100% - 1rem);
    padding: 0.75rem 0.5rem;
    background-color: transparent;
    align-items: center;
    transition: transform 0.3s ease;
  }

  /* Show mobile nav on mobile and tablet */
  @media (max-width: 600px), (max-width: 1024px) and (pointer: coarse) {
    nav {
      display: flex;
    }
  }

  .logo-link {
    display: flex;
    align-items: center;
    text-decoration: none;
    color: var(--color);
  }

  .logo-image {
    margin-left: .7rem;
    height: 32px;
    width: auto;
    border-radius: 0;
    color: var(--color);
  }

  .spacer {
    flex: 1;
  }

  .burger-button {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    width: 44px;
    height: 44px;
    padding: 0;
    background-color: var(--bg-color);
    border: none;
    border-radius: 8px;
    cursor: pointer;
    gap: 5px;
    z-index: 1001;
    margin-left: 0.5rem;
    transition: background-color 0.3s ease;
  }

  .burger-line {
    width: 24px;
    height: 2px;
    background-color: var(--color);
    transition: all 0.3s ease;
    transform-origin: center;
  }

  /* Burger to X animation when open */
  .burger-button.open .burger-line:nth-child(1) {
    transform: translateY(7px) rotate(45deg);
  }

  .burger-button.open .burger-line:nth-child(2) {
    opacity: 0;
    transform: scaleX(0);
  }

  .burger-button.open .burger-line:nth-child(3) {
    transform: translateY(-7px) rotate(-45deg);
  }

  /* Fullscreen menu overlay */
  .mobile-menu {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: var(--bg-color);
    z-index: 999;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition:
      opacity 0.3s ease,
      visibility 0.3s ease;
  }

  .mobile-menu.open {
    opacity: 1;
    visibility: visible;
  }

  .menu-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.5rem;
    transform: translateY(20px);
    opacity: 0;
    transition:
      transform 0.4s ease 0.1s,
      opacity 0.4s ease 0.1s;
  }

  .mobile-menu.open .menu-content {
    transform: translateY(0);
    opacity: 1;
  }

  .menu-item {
    font-family: "nudica_monobold", serif;
    font-size: 2rem;
    text-decoration: none;
    color: var(--color);
    padding: 0.5rem 1rem;
    position: relative;
    transition:
      color 0.2s ease,
      transform 0.2s ease;
  }

  .menu-item:hover {
    transform: scale(1.05);
    opacity: 1;
  }

  .menu-item.active {
    color: var(--accent-color);
  }

  .menu-item.active::before {
    content: "â†’";
    position: absolute;
    left: -1.5rem;
    color: var(--accent-color);
  }

  .menu-label {
    position: relative;
  }

  .menu-item::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 50%;
    width: 0;
    height: 2px;
    background-color: var(--accent-color);
    transition:
      width 0.3s ease,
      left 0.3s ease;
  }

  .menu-item:hover::after {
    width: 100%;
    left: 0;
  }

  /* PWA mode padding */
  @media (max-width: 600px) and (display-mode: standalone),
    (max-width: 1024px) and (pointer: coarse) and (display-mode: standalone) {
    nav {
      padding-top: 1.1rem;
    }
  }

  /* Class-based PWA mode (applied by JS) */
  nav.pwa-mode {
    padding-top: 1.1rem;
  }
</style>

<script is:inline>
  const setupMobileNav = () => {
    const nav = document.getElementById("mobile-nav");
    const burgerButton = document.getElementById("burger-button");
    const mobileMenu = document.getElementById("mobile-menu");

    if (!burgerButton || !mobileMenu || !nav) return;

    // Detect if running as PWA
    const isPWA =
      window.matchMedia("(display-mode: standalone)").matches ||
      window.navigator.standalone ||
      document.referrer.includes("android-app://");

    // Check if device is mobile or tablet
    const isMobileOrTablet =
      window.innerWidth <= 600 ||
      (window.innerWidth <= 1024 &&
        window.matchMedia("(pointer: coarse)").matches);

    // Apply PWA mode padding
    if (isPWA && isMobileOrTablet) {
      nav.classList.add("pwa-mode");
    } else {
      nav.classList.remove("pwa-mode");
    }

    // Toggle menu
    const toggleMenu = () => {
      const isOpen = burgerButton.classList.contains("open");

      if (isOpen) {
        burgerButton.classList.remove("open");
        mobileMenu.classList.remove("open");
        burgerButton.setAttribute("aria-expanded", "false");
        mobileMenu.setAttribute("aria-hidden", "true");
        document.body.style.overflow = "";
      } else {
        burgerButton.classList.add("open");
        mobileMenu.classList.add("open");
        burgerButton.setAttribute("aria-expanded", "true");
        mobileMenu.setAttribute("aria-hidden", "false");
        document.body.style.overflow = "hidden";
      }
    };

    // Remove existing listeners (for Astro View Transitions)
    const newBurgerButton = burgerButton.cloneNode(true);
    burgerButton.parentNode.replaceChild(newBurgerButton, burgerButton);

    newBurgerButton.addEventListener("click", toggleMenu);

    // Close menu when clicking a link
    const menuLinks = mobileMenu.querySelectorAll(".menu-item");
    menuLinks.forEach((link) => {
      link.addEventListener("click", () => {
        newBurgerButton.classList.remove("open");
        mobileMenu.classList.remove("open");
        newBurgerButton.setAttribute("aria-expanded", "false");
        mobileMenu.setAttribute("aria-hidden", "true");
        document.body.style.overflow = "";
      });
    });

    // Close menu on escape key
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && mobileMenu.classList.contains("open")) {
        toggleMenu();
      }
    });
  };

  const setupMobileNavScroll = () => {
    const nav = document.getElementById("mobile-nav");
    const mobileMenu = document.getElementById("mobile-menu");
    let lastScrollY = window.scrollY;
    const navHeight = nav?.offsetHeight || 0;

    // Threshold - how many pixels to scroll before hiding/showing the nav
    const scrollThreshold = 10;

    function handleScroll() {
      if (!nav) return;

      // Don't hide nav when menu is open
      if (mobileMenu?.classList.contains("open")) {
        return;
      }

      const currentScrollY = window.scrollY;
      const scrollDifference = currentScrollY - lastScrollY;

      // If we're at the very top, always show the nav
      if (currentScrollY <= 0) {
        nav.style.transform = "translateY(0)";
      }
      // Scrolling down and past threshold, hide the nav
      else if (scrollDifference > scrollThreshold) {
        nav.style.transform = `translateY(-${navHeight}px)`;
      }
      // Scrolling up and past threshold, show the nav
      else if (scrollDifference < -scrollThreshold) {
        nav.style.transform = "translateY(0)";
      }

      // Only update lastScrollY if we passed the threshold
      if (Math.abs(scrollDifference) > scrollThreshold) {
        lastScrollY = currentScrollY;
      }
    }

    // Throttle scroll events for performance
    let ticking = false;
    window.addEventListener("scroll", () => {
      if (!ticking) {
        window.requestAnimationFrame(() => {
          handleScroll();
          ticking = false;
        });
        ticking = true;
      }
    });
  };

  // Initialize
  setupMobileNav();
  setupMobileNavScroll();

  // For Astro View Transitions
  document.addEventListener("astro:page-load", () => {
    setupMobileNav();
    setupMobileNavScroll();
  });

  // Handle resize
  window.addEventListener("resize", setupMobileNav);
</script>
